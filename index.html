<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allowance Calculator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      padding: 20px 30px;
      border-radius: 8px;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }

    .modal h2 {
      margin-top: 0;
    }

    .modal label {
      display: block;
      margin: 12px 0 6px;
    }

    .modal input[type="number"],
    .modal select {
      width: 100%;
      padding: 8px 6px;
      box-sizing: border-box;
    }

    .modal button {
      margin-top: 16px;
      width: 100%;
      padding: 10px;
      background-color: #04AA6D;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
    }

    .modal button:hover {
      background-color: #039f5b;
    }

    table {
      border-collapse: collapse;
      margin-top: 30px;
      width: 300px;
    }

    th, td {
      border: 1px solid #999;
      padding: 6px 10px;
      text-align: center;
      font-family: monospace;
    }

    th {
      background-color: #f0f0f0;
    }

    .total-row {
      font-weight: bold;
      background-color: #d0f0d0;
    }
  </style>
</head>
<body>

<div class="modal-overlay" id="popup">
  <div class="modal">
    <h2>Enter USD Rate & Allowance Category</h2>
    <form id="inputForm">
      <label for="usdRate">USD Rate (LKR per USD):</label>
      <input type="number" id="usdRate" name="usdRate" min="0" step="0.01" required />

      <label for="allowanceCategory">Allowance Category:</label>
      <select id="allowanceCategory" name="allowanceCategory" required>
        <option value="" disabled selected>Select category</option>
        <option value="125">A (125 USD)</option>
        <option value="500">B (500 USD)</option>
        <option value="1000">C (1000 USD)</option>
        <option value="125">D2 (125 USD)</option>
      </select>

      <button type="submit">Submit</button>
    </form>
  </div>
</div>

<div id="outputContainer" style="display:none;">
  <table id="outputTable" aria-label="Allowance Calculation Output">
    <thead>
      <tr>
        <th>J</th>
        <th>K</th>
        <th>L</th>
      </tr>
    </thead>
    <tbody>
      </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(function() {
    const popup = $('#popup');
    const outputContainer = $('#outputContainer');
    const outputTableBody = $('#outputTable tbody');

    popup.addClass('active');

    let usdRate = null;
    let allowanceValue = null;

    // Load data from Google Sheet (F3:H62)
    const jsonData = [
      {"Item": "Assorted Food Stuff", "Units": "", "Value": "10000"},
      {"Item": "Assorted Glassware", "Units": "", "Value": "7000"},
      {"Item": "Assorted Kitchenware", "Units": "", "Value": "12000"},
      {"Item": "Bathroom Set with Acc.", "Units": "1", "Value": "30000"},
      {"Item": "Dinner Set", "Units": "1", "Value": "10000"},
      {"Item": "Hand Bag", "Units": "1", "Value": "10000"},
      {"Item": "Paint", "Units": "30 l", "Value": "15000"},
      {"Item": "Rice Cooker", "Units": "1", "Value": "30000"},
      {"Item": "Toileteries", "Units": "", "Value": "12000"},
      {"Item": "Toys", "Units": "", "Value": "12000"},
      {"Item": "Used Air Cooler", "Units": "1", "Value": "10000"},
      {"Item": "Used Beds", "Units": "1", "Value": "15000"},
      {"Item": "Used Bedspreads", "Units": "4", "Value": "4000"},
      {"Item": "Used Bicycle", "Units": "1", "Value": "10000"},
      {"Item": "Used TV 43''", "Units": "1", "Value": "43000"},
      {"Item": "Used Free St. Cooker", "Units": "1", "Value": "30000"},
      {"Item": "Ladies Hand Bags", "Units": "1", "Value": "8000"},
      {"Item": "Used Hand Tool Set", "Units": "1", "Value": "10000"},
      {"Item": "Used Iron", "Units": "1", "Value": "15000"},
      {"Item": "Rice Cooker", "Units": "1", "Value": "30000"},
      {"Item": "Used PC", "Units": "1", "Value": "30000"},
      {"Item": "Used Bicycle", "Units": "2", "Value": "20000"},
      {"Item": "Toys", "Units": "", "Value": "12000"},
      {"Item": "Used Hot Plate", "Units": "1", "Value": "10000"},
      {"Item": "Used Blender", "Units": "1", "Value": "20000"},
      {"Item": "Used Beds", "Units": "", "Value": "26000"},
      {"Item": "Used Blankets", "Units": "", "Value": "10000"},
      {"Item": "Used Carpets", "Units": "", "Value": "12000"},
      {"Item": "Assorted Food Stuff", "Units": "", "Value": "13000"},
      {"Item": "Toileteries", "Units": "", "Value": "12000"},
      {"Item": "Used Blender", "Units": "1", "Value": "15000"},
      {"Item": "Used Carpets", "Units": "", "Value": "12000"},
      {"Item": "Used Chandelier", "Units": "1", "Value": "15000"},
      {"Item": "Used Cooker Hood", "Units": "1", "Value": "10000"},
      {"Item": "Used Curtain Set", "Units": "1", "Value": "20000"},
      {"Item": "Used D. Room. Suite", "Units": "1", "Value": "15000"},
      {"Item": "Used Ex. Machine", "Units": "1", "Value": "15000"},
      {"Item": "Used Free St. Cooker", "Units": "1", "Value": "35000"},
      {"Item": "Used Hand Tool Set", "Units": "1", "Value": "10000"},
      {"Item": "Used Hot Plate", "Units": "1", "Value": "10000"},
      {"Item": "Used Hot Water Geyser", "Units": "1", "Value": "15000"},
      {"Item": "Used Iron", "Units": "1", "Value": "15000"},
      {"Item": "Used Ladder", "Units": "1", "Value": "10000"},
      {"Item": "Used Laptop", "Units": "1", "Value": "30000"},
      {"Item": "Used Lawn Mower", "Units": "1", "Value": "30000"},
      {"Item": "Used Mattress", "Units": "1", "Value": "10000"},
      {"Item": "Used Mic. Oven", "Units": "1", "Value": "15000"},
      {"Item": "Used PC", "Units": "1", "Value": "30000"},
      {"Item": "Used Portable Gene.", "Units": "1", "Value": "25000"},
      {"Item": "Used Pre. Washer", "Units": "1", "Value": "15000"},
      {"Item": "Used Ref (CFC Free)", "Units": "1", "Value": "40000"},
      {"Item": "Used Rugs", "Units": "1", "Value": "12000"},
      {"Item": "Used Sewing Machine", "Units": "1", "Value": "15000"},
      {"Item": "Used Sofa", "Units": "1", "Value": "45000"},
      {"Item": "Used Sports Eq.", "Units": "2", "Value": "10000"},
      {"Item": "Used Toaster", "Units": "1", "Value": "5000"},
      {"Item": "Used Vac. Cleaner", "Units": "1", "Value": "15000"},
      {"Item": "Used Water Heater", "Units": "1", "Value": "15000"},
      {"Item": "Washing Powder", "Units": "10 kg", "Value": "10000"},
      {"Item": "Used TV 32\"", "Units": "1", "Value": "32000"},
      {"Item": "Used TV 43\"", "Units": "1", "Value": "43000"},
      {"Item": "Used TV 50\"", "Units": "1", "Value": "50000"}
    ];

    function generateOutput() {
      outputTableBody.empty();

      const total = allowanceValue * usdRate;
      const rowsCount = 33;
      let accumulatedValue = 0;

      for (let i = 0; i < rowsCount; i++) {
        const itemIndex = i % jsonData.length;
        const item = jsonData[itemIndex];

        let itemValue = parseFloat(item.Value);
        if (isNaN(itemValue)) {
          itemValue = 0;
        }

        const remainingValue = total - accumulatedValue;
        let lCellValue = Math.min(itemValue, remainingValue);

        if (lCellValue < 0) {
          lCellValue = 0;
        }

        accumulatedValue += lCellValue;

        const jCell = i + 1;
        const kCell = item.Item;
        lCellValue = parseFloat(lCellValue.toFixed(2));

        outputTableBody.append(
          `<tr>
            <td>${jCell}</td>
            <td>${kCell}</td>
            <td>${lCellValue}</td>
          </tr>`
        );

        if (accumulatedValue >= total) {
          break;
        }
      }

      const formattedTotal = parseFloat(total.toFixed(2));
      outputTableBody.append(
        `<tr class="total-row">
          <td colspan="2">Total</td>
          <td>${formattedTotal}</td>
        </tr>`
      );
    }

    $('#inputForm').on('submit', function(e) {
      e.preventDefault();
      usdRate = parseFloat($('#usdRate').val());
      allowanceValue = parseFloat($('#allowanceCategory').val());

      if (isNaN(usdRate) || usdRate <= 0) {
        alert('Please enter a valid USD rate.');
        return;
      }
      if (isNaN(allowanceValue) || allowanceValue <= 0) {
        alert('Please select a valid allowance category.');
        return;
      }

      popup.removeClass('active');
      outputContainer.show();
      generateOutput();
    });
  });
</script>

</body>
</html>
