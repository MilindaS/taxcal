<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Allowance Calculator - Exact J1:L33 Output</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    justify-content: center;
    align-items: center;
  }
  .modal-overlay.active {
    display: flex;
  }
  .modal {
    background: white;
    padding: 20px 30px;
    border-radius: 8px;
    max-width: 320px;
    width: 100%;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  .modal h2 {
    margin-top: 0;
  }
  .modal label {
    display: block;
    margin: 12px 0 6px;
  }
  .modal input[type="number"],
  .modal select {
    width: 100%;
    padding: 8px 6px;
    box-sizing: border-box;
  }
  .modal button {
    margin-top: 16px;
    width: 100%;
    padding: 10px;
    background-color: #04AA6D;
    border: none;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    border-radius: 4px;
  }
  .modal button:hover {
    background-color: #039f5b;
  }
  table {
    border-collapse: collapse;
    margin-top: 30px;
    width: 600px;
    max-width: 100%;
  }
  th, td {
    border: 1px solid #999;
    padding: 6px 10px;
    text-align: left;
    font-family: monospace;
    vertical-align: top;
  }
  th {
    background-color: #f0f0f0;
    text-align: center;
  }
  td.number {
    text-align: right;
    white-space: nowrap;
  }
  .total-row {
    font-weight: bold;
    background-color: #d0f0d0;
  }
</style>
</head>
<body>

<div class="modal-overlay" id="popup">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h2 id="modalTitle">Enter USD Rate & Allowance Category</h2>
    <form id="inputForm">
      <label for="usdRate">USD Rate (LKR per USD):</label>
      <input type="number" id="usdRate" name="usdRate" min="0" step="0.01" required aria-required="true" />

      <label for="allowanceCategory">Allowance Category:</label>
      <select id="allowanceCategory" name="allowanceCategory" required aria-required="true">
        <option value="" disabled selected>Select category</option>
        <option value="125">A (125 USD)</option>
        <option value="500">B (500 USD)</option>
        <option value="1000">C (1000 USD)</option>
        <option value="125">D2 (125 USD)</option>
      </select>

      <button type="submit">Submit</button>
    </form>
  </div>
</div>

<div id="outputContainer" style="display:none;">
  <table id="outputTable" aria-label="Allowance Calculation Output">
    <thead>
      <tr>
        <th>J</th>
        <th>K</th>
        <th>L</th>
      </tr>
    </thead>
    <tbody>
      <!-- Rows inserted by script -->
    </tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
  const popup = $('#popup');
  const outputContainer = $('#outputContainer');
  const outputTableBody = $('#outputTable tbody');

  popup.addClass('active');

  let usdRate = null;
  let allowanceValue = null;

  // Exact data for J1:L33 from your sheet (including remarks)
  // Note: Adjusted sample data based on your sheet and instructions.
  // Columns: J = number, K = description/remarks, L = value (LKR)
  // For brevity, I include 33 rows with sample remarks and values.
  // Replace these with your exact J1:L33 content if you want exact text.

  const j1_l33_data = [
    {J:"1",  K:"Assorted Food Stuff",               L:10000},
    {J:"2",  K:"Assorted Glassware",                L:7000},
    {J:"3",  K:"Assorted Kitchenware",              L:12000},
    {J:"4",  K:"Bathroom Set with Acc.",            L:30000},
    {J:"5",  K:"Dinner Set",                        L:10000},
    {J:"6",  K:"Hand Bag",                          L:10000},
    {J:"7",  K:"Paint 30 l",                        L:15000},
    {J:"8",  K:"Rice Cooker",                       L:30000},
    {J:"9",  K:"Toileteries",                       L:12000},
    {J:"10", K:"Toys",                             L:12000},
    {J:"11", K:"Used Air Cooler",                   L:10000},
    {J:"12", K:"Used Beds",                         L:15000},
    {J:"13", K:"Used Bedspreads",                   L:4000},
    {J:"14", K:"Used Bicycle",                      L:10000},
    {J:"15", K:"Used TV 43''",                      L:43000},
    {J:"16", K:"Used Free Standing Cooker",         L:30000},
    {J:"17", K:"Ladies Hand Bags",                   L:8000},
    {J:"18", K:"Used Hand Tool Set",                 L:10000},
    {J:"19", K:"Used Iron",                          L:15000},
    {J:"20", K:"Rice Cooker",                        L:30000},
    {J:"21", K:"Used PC",                            L:30000},
    {J:"22", K:"Used Bicycle",                       L:20000},
    {J:"23", K:"Toys",                              L:12000},
    {J:"24", K:"Used Hot Plate",                     L:10000},
    {J:"25", K:"Used Blender",                       L:20000},
    {J:"26", K:"Used Beds",                          L:26000},
    {J:"27", K:"Used Blankets",                      L:10000},
    {J:"28", K:"Used Carpets",                       L:12000},
    {J:"29", K:"Assorted Food Stuff",                L:13000},
    {J:"30", K:"Toileteries",                        L:12000},
    {J:"31", K:"Used Blender",                       L:15000},
    {J:"32", K:"Used Carpets",                       L:12000},
    {J:"33", K:"Used Chandelier",                    L:15000}
  ];

  // Calculate sum of original L values
  function sumOriginalValues() {
    return j1_l33_data.reduce((acc, row) => acc + row.L, 0);
  }

  // Generate output table with L values scaled to total = allowanceValue * usdRate
  function generateOutput() {
    outputTableBody.empty();

    const totalTarget = allowanceValue * usdRate;
    const originalSum = sumOriginalValues();

    // Scale factor to adjust all L values proportionally
    const scale = totalTarget / originalSum;

    // Track sum of scaled values for precision adjustment
    let accumulated = 0;

    for (let i = 0; i < j1_l33_data.length; i++) {
      const row = j1_l33_data[i];
      let scaledValue = row.L * scale;

      // For the last row, adjust to fix floating point rounding errors
      if (i === j1_l33_data.length - 1) {
        scaledValue = totalTarget - accumulated;
      } else {
        scaledValue = parseFloat(scaledValue.toFixed(2));
        accumulated += scaledValue;
      }

      outputTableBody.append(`
        <tr>
          <td>${row.J}</td>
          <td>${row.K}</td>
          <td class="number">${scaledValue.toFixed(2)}</td>
        </tr>
      `);
    }

    // Add total row
    outputTableBody.append(`
      <tr class="total-row">
        <td colspan="2">Total</td>
        <td class="number">${totalTarget.toFixed(2)}</td>
      </tr>
    `);
  }

  $('#inputForm').on('submit', function(e) {
    e.preventDefault();
    usdRate = parseFloat($('#usdRate').val());
    allowanceValue = parseFloat($('#allowanceCategory').val());

    if (isNaN(usdRate) || usdRate <= 0) {
      alert('Please enter a valid USD rate.');
      return;
    }
    if (isNaN(allowanceValue) || allowanceValue <= 0) {
      alert('Please select a valid allowance category.');
      return;
    }

    popup.removeClass('active');
    outputContainer.show();
    generateOutput();
  });
});
</script>

</body>
</html>
